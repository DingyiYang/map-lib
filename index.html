<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1"/>
    <title>Map Visualization Library</title>
 
    <style>
        html,body{
            background:rgb(200,200,200);
            width:100%;
            height:100%;
        }
        .title{
                fill:rgb(192,143,145);
                font-weight: bold;
                text-decoration:underline;
        }
        .shadow{
              stroke: white;
              font-weight: bold;
              text-decoration:underline;
              stroke-width: 0.4%;
              opacity: 0.7;

        }
        .point_text{

        }
        .point_text_shadow{
              stroke: white;
              font-size: 60%;
              stroke-width: 0.2%;
              opacity: 0.9;

        }
        .source_text{
                fill:rgb(80,80,80);
                font-weight: bold;
                text-decoration:underline;
        }
        .state {
            fill: rgb(160,160,160);
            stroke: white;
            stroke-width: 0.06%;
            cursor:pointer;
        }
        .axis path,
        .axis line{
            fill: none;
            stroke: black;
            stroke-width:0.15vh;
            shape-rendering: crispEdges;
        }
        .axis text {
            font-size: 1vmin;
        }
        .links{
        fill:none;
        /*stroke:rgb(227,113,40);*/
        stroke: white;
        stroke-width:0.23%;
         }
        .title_text{
            font-size: 30;
            fill: #ffffff;
            fill-opacity: .4;
        }
        .country_text{
            fill:rgb(50,50,50);
            fill-opacity:1;
            cursor:pointer;
            stroke: white;
            stroke-width: 0.0012vmin;
            stroke-opacity:0.5; 
            font-family: "Microsoft JhengHei";
            font-weight: 550;
        }
        .country_text2{
            fill:rgb(50,50,50);
            fill-opacity:1;
            cursor:pointer;
            stroke: white;
            stroke-width: 0.0012vmin;
            stroke-opacity:0.5;
            font-family: "Microsoft JhengHei";
            font-weight: bold;
        }
        .mouseover_text_1{
            fill:rgb(50,50,50);
            fill-opacity:.8;
            cursor:pointer;
            font-family: "Khand-Regular";
        }
        .mouseover_text_2{
            fill:rgb(50,50,50);
            fill-opacity:.8;
            cursor:pointer;
            font-family: "Khand-Regular";
        }
        .range_name{
            fill:white;
            fill-opacity:0.8;
            font-weight:bold;
        }
        .range_text{
            font-weight: bold;
        }

        .rect{
            /*stroke: rgb(200,200,200);*/
        }

        #floor {            
            clear: both;
            display: block;
            text-align: center; 
            margin: 0px auto;
            position: absolute;
            bottom: 0px;
            width: 100%;
            font-size:2vmin;
            color: rgb(60,60,60);
        }
        #header{
            position: absolute;
            top:0%;
            left:0%;
            width:100%;
            height:6%;
            border:.2vmin solid rgb(60,60,60);
            background:rgb(40,40,40);
        }
        .titleText{           
            position: absolute;
            left:2%;
            top:10%;
            font-size:3vh;
            font-family: Khand-Regular;
            color:rgb(180,180,180);
        }
        .mapPanel{
            position: absolute;
            top:6%;
            left:15%;
            width:85%;
            height:94%;
            //border:.2vmin solid rgb(60,60,60);
        }
        .selectBox{
            box-shadow: -.6rem 0 .6rem 0 rgba(0, 0, 0, 0.4);
        }
        .selectPanel{
            position: absolute;
            top:6%;
            left:0%;
            width:15%;
            height:94%;
            border:.3vmin solid rgb(60,60,60);
            font-size:2vmin; 
            font-family: Khand-Regular
        }
            .generateMap{
                position: relative;
                top:1%;
                left:2%;
                width:96%;
                height:20%;        
            }
                .selectTitle{
                    position: absolute;
                    top:1%;
                    left:5%;
                    width:95%;
                    height:5%;
                    font-size:2.5vmin; 
                }
                .existData{
                    position: absolute;
                    top:20%;
                    left:10%;
                    width:90%;
                    height:75%;            
                }
            .changeStyle{
                position: relative;
                top:2%;
                left:2%;
                width:96%;
                height:26%;        
            }
                .styleTypes{
                    position: absolute;
                    top:15%;
                    left:10%;
                    width:90%;
                    height:75%;  
                }
            .uploadData{
                position: relative;
                top:3%;
                left:2%;
                width:96%;
                height:50%;        
            }
                .uploadPanel{
                    position: absolute;
                    top:10%;
                    left:10%;
                    width:82%;
                    height:30%;
                    background-color:rgb(190,190,190);
                    font-size:1.8vmin;
                }
                .detailsText{
                    position: absolute;
                    top:6%;
                    left:5%;
                    width:90%;
                    font-family: "Georgia";
                }
        .mybutton{
            background-color: rgb(220,220,220);
            color: rgb(80,80,80);
            border: 0.2vmin solid rgb(160,160,160);
            -moz-border-radius:1vmin;  
            -webkit-border-radius:1vmin;  
            font-size: 1.7vmin;
        }
        #chiButton{           
            position: absolute;
            top:20%;
            left:90%;
            width:3%;
            height: 60%;
        }
        #engButton{           
            position: absolute;
            top:20%;
            left:94%;
            width:3%;
            height: 60%;
        }

        .partitionLine{
            position: absolute;
            top:4.5%;
            left:15%;
        }


    }

    option{
        width:100%;
        background:none;
        border:4px dashed #ccc;
    }
    select{
        width:90%;
        height:3.2vh;
        border:0px solid #6699FF;
        background-color:rgb(240,240,240);
        font-size:2vmin;
    }
    div text{
        font-family:Arial;
    }
    #hide_img{
      position: absolute;
      top: 80%;
      left: 15.1%;
      height: 8vmin;
      width: 4vmin;
  }
  #show_img{
      position: absolute;
      top: 80%;
      left: 1%;
      height: 8vmin;
      width: 4vmin;

    </style>
</head>
 
<body>
<div id="header">
    <div class="titleText">Map Visualization Library</div>
        <button onclick="changeLan()" class="mybutton" id="chiButton">ä¸­</button>
        <button onclick="changeLan()" class="mybutton" id="engButton">EN</button>
</div>
<div class="mapPanel">
    <div id="floor">
      &copy PKU Visualization and Visual Analytics Group
    </div>
</div>
<!--div class="partitionLine"><hr style="height:100vh;fill:rgb(60,60,60)"></div!-->
<img id="hide_img" onclick="HideLeftView()" src="hidden.png" />
<img id="show_img" onclick="ShowLeftView()" src="show.png" style="display: none;" />
<div class="selectPanel" id="LeftSelectPanel">
    <div class="generateMap selectBox">
        <div class="selectTitle">
            <span>Generate map</span>
        </div>
        <div class="existData">
            <span>Select base map</span><br>
            <select name="test" onchange="changeBasicMap(this.options[this.options.selectedIndex].value)">
                <option value="world">world</option>
                <!--option value="china">china</option!-->
            </select>
            <br><span>Select dataset</span><br>
            <select name="test" onchange="changeDataSet(this.options[this.options.selectedIndex].value)">
                <option value="nCoV">nCoV</option>
                <option value="ASF">African swine fever</option>
            </select> 
        </div>
    </div>
    <div class="changeStyle selectBox">
        <div class="selectTitle">
            <span>Style</span>
        </div>
        <div class="styleTypes">
            <span>Line</span><br>
            <select name="test" onchange="changeLineColor(this.options[this.options.selectedIndex].value)">
                <option value="white">White</option>
                <option value="rgb(110,110,110)">Gray</option>
            </select>
            <br><span>Circle</span><br>
            <select name="test" onchange="changeCircleColor(this.options[this.options.selectedIndex].value)">
                <option value="rgb(247,254,174)">Yellow</option>
                <option value="white">White</option>
            </select>
            <br><span>Color Scale</span><br>
            <select name="test" onchange="changeColorRange(this.options[this.options.selectedIndex].value)">
                <option value="0">Red Group</option>
                <!--option value="1">Blue Group</option>
                <option value="2">Yellow Group</option!-->
            </select>
        </div>
    </div>
    <div class="uploadData selectBox">
        <div class="selectTitle">
            <span>Upload Data</span>
        </div>
        <div class="uploadPanel">
            <div class="detailsText">
                <span>You can create new maps by uploading your own data.</span><br><br>
                <span>For details and structures of the data, please check the descriptions.</span><br>
            </div>
        </div>
    </div>
</div>

<!--div class="box" style="position:absolute;left:0px;top:0px">
    <div class="content">
        <span>Line</span><br>
        <select name="test">
            <option value="0">White</option>
            <option value="1">Red</option>
        </select>
        <br><span>Circle</span><br>
        <select name="test">
            <option value="0">Yellow</option>
            <option value="1">White</option>
        </select>
        <br><span>Color Scale</span><br>
        <select name="test">
            <option value="0">Red Group</option>
            <option value="1">Blue Group</option>
            <option value="2">Yellow Group</option>
        </select>
    </div>
    <input type="button" class="showButton" value="éè">
<script type="text/javascript" src="jquery-1.10.2.min.js"></script>
<script type="text/javascript">
    $(function(){
    $(".content").show(); // é»è®¤éèä¸ææ¡
    //$(":button").click(function() {
    $(".showButton").click(function() {
        $(".content").toggle();  // å·²ç»æ¾ç¤ºåéèï¼éèäºåæ¾ç¤º
        $(this).val($(this).val()=="æ¾ç¤º"?"éè":"æ¾ç¤º");
    })
})

</script>
</div!-->

<div id="view" style="position:absolute;left:40px;top:200px">
<script src="d3.v4.min.js"></script>
<script type="text/javascript" src="jquery-1.10.2.min.js"></script>
<script>
    $(window).resize(function(){
        //alert("çªä½å¤§å°æ¹åäºï¼");
        location.replace(location.href); 
    });
//å¼å§è¿è¡æ°æ®å®ä¹
    let self=this

    var brush_flag=0;
    let inTimeRect=0;
    let play_flag=0;//è¡¨ç¤ºæ¯å¦æ­£å¨æ­æ¾
    let isEnd=1;
    let inline=0;
    let incircle=0;
    //èå´æ°æ®ï¼å¯ä»¥æ¯æ¶é´èå´æèæ°æ®èå´ï¼
    let web_title
    let chinese_title
    let data_range
    let axis_range
    let data_point
    let dataSource
    let dataSource_chinese
    let data_url
    let mapSource
    let map_url
    let num_unit
    let chineses_unit
    let show_path
    let use_brush
    let use_dragBlock

    let line_color=["white","gray"]
    let circle_color=["yellow","white"]
    let color_scales={}

    let selected_map="world"
    let selected_dataset="nCoV"
    //æ°æ®æ¯å¦ä¸ºæ¥ææ ¼å¼ï¼å¦ææ¯çè¯ï¼éè¦å¨è¿è¡æ¶é´è½´ç¸å³æä½æ¶è¿è¡æ¢ç®
    let is_date=0
    let animation_t
    let change_view=0
    let temp_time
   
    /*data_range=[{"name":"1909-1956","id":0,"range":[1909,1956]},
                {"name":"1957-1977","id":1,"range":[1957,1977]},
                {"name":"1978-1995","id":2,"range":[1978,1995]},
                {"name":"1996-2009","id":3,"range":[1996,2009]},
                {"name":"2010-2019","id":4,"range":[2010,2019]}]
    //å³é®äºä»¶çæ°æ®
    data_point=[{"year":1909,"event":"First detected in Kenya","chinese_event":"é¦æ¬¡å¨è¯å°¼äºåç°"},
                {"year":1957,"event":"Introduced into Europe","chinese_event":"ä¼ æ­å°æ¬§æ´²"},
                {"year":1978,"event":"Spread to South America, ","chinese_event":"èå»¶å°åç¾,"},
                {"year":1978,"event":"line2:Central Africa  ","chinese_event":"line2:ä¸­é"},
                {"year":1996,"event":"Outbreak in Ivory Coast","chinese_event":"å¨ç§ç¹è¿ªç¦ä»¥å"},
                {"year":1996,"event":"line2:and countries nearby","chinese_event":"line2:å¨å´å½å®¶çå"},
                {"year":2007,"event":"Spread to Caucasus","chinese_event":"ä¼ æ­å°é«å ç´¢å°åº"},
                {"year":2018,"event":"Occurred in China","chinese_event":"å¨ä¸­å½çå"}]*/
    //å°å¾ç»å¶çæ°æ® 
    let map_data={}
    //å°å¾ç»å®çä¿¡æ¯çæ°æ®
    let statistics_data={}
    //è¿çº¿æ°æ®
    let path_data={}
    //é¡µé¢å¶ä»ä¿¡æ¯çæ°æ®
    let component_data={}

    var event_years=[1957,1996,2000]

    let best_scale=600/1280
    let screen_scale=540/1280
    let screen_scale2=680/1280
    let screen_scale3=1.2
    let font_scale=1
    let temp_lan="english"
    let temp_map="world"
    /*var width = document.body.clientWidth; 
    var height = document.body.clientHeight;*/
    //var width = Math.min(window.innerWidth,document.body.clientWidth); 
    //var height = Math.min(window.innerHeight,document.body.clientHeight);
    //å®½åº¦
    let width=$('.mapPanel').width()
    //é«åº¦
    let height=$('.mapPanel').height()
    font_scale=Math.min(height/screen.height,width/screen.width)*1.2
    let svg_x=height*0.005
    let svg_y=height*0.005
    width=width-svg_x*2
    height=height-svg_y*2
    //console.log("width="+width)
    //console.log("height="+height)
    if(height>width*screen_scale3){
        svg_y=height/8
        height=height*3/4
        width=height/screen_scale2
        font_scale=Math.min(height/screen.height,width/screen.width)*1.2
    }
    else if(height>width*screen_scale2){
        svg_y=(height-width*screen_scale2)/2
        height=width*screen_scale2
        font_scale=Math.min(height/screen.height,width/screen.width)*1.2
    }
    else if(width>height/screen_scale){
        svg_x=(width-height/screen_scale)/2
        width=height/screen_scale
        font_scale=Math.min(height/screen.height,width/screen.width)*1.2
    }
    //console.log(width)
    //console.log(height)

    var color=d3.scaleLinear()
        .domain([0, 4])
        .range(["rgba(238,140,132,0.8)","rgba(187,0,0,1)" ])
        .interpolate(d3.interpolateHcl);
    /*var color = d3.scaleLinear()
        .domain([0, 4])
        .range(["rgb(253,215,108)","rgb(252,200,44)"])
        .interpolate(d3.interpolateHcl);*/
    var bascolor=["rgb(238,238,238)","rgb(111,213,201)","rgb(255,176,93)","rgb(255,119,105)","rgb(165,200,233)","rgb(244,172,88)"];
    let svg=d3.select(".mapPanel").append("svg")
        .attr("transform", "translate("+svg_x+","+svg_y+")")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        //.attr("transform", "translate(0,0)");
 

    var tooltip = d3.select("#tooltip");
 
    let proj_world=d3.geoMercator()
                        .center([0, 16])
                        .scale(d3.min([width/4.1,height/2.3])*0.7)
                        .translate([width/2, height/2]);
    let proj_china=d3.geoMercator()
                        .center([100, 38])
                        .scale(d3.min([width/1.8,height*1.2]))
                        .translate([width/2, height/2]);
    let proj=proj_world

    let path = d3.geoPath().projection(proj);

    var tooltip = d3.select("#tooltip");

    let axis_start=1900;
    let axis_end=2019;
    let is_rect2axis=1;
    let show_detail=0 
    //å¦ææ°æ®æ¯æ¥æåæ°æ®çè¯ï¼éè¦åå§æ¥æç»å
    let start_date
    let stop_year=1909;//è¡¨ç¤ºæåæ¶æå¤çå¹´ä»½
            timelineLen=height*0.35;//æ¶é´è½´é¿åº¦
    timelineX=width*0.12
            timelineY=height*0.085
    var tScale=d3.scaleLinear()
                .domain([axis_start,axis_end])
                .range([0, timelineLen]);

    let inmap_flag=0
    let hasPath=0
    let inmap=0
    let intext=0

//åæµ·
d3.xml("southchinasea.svg", function(error, xmlDocument) {
                    svg.html(function(d){
                            return d3.select(this).html() + xmlDocument.getElementsByTagName("g")[0].outerHTML;
                    });
                
                    let gSouthSea = d3.select("#southsea").attr("stroke","white")
                    .attr("stroke-width",".2rem")
                    .attr("fill","none")
                    .attr("opacity",function(){
                        if(temp_map=="china") return 0.8
                        else return 0
                    });
                
                gSouthSea.attr("transform","translate("+width*0.76+","+height*0.76+")scale(0.4)")
                    .attr("class","southsea");
         
            });
//è·åæ°æ®
    changeView(temp_map+"_"+selected_dataset+".json","path_"+selected_dataset+".json",temp_map+"_web_info_"+selected_dataset+".json")
    HideLeftView()


//è·åæ°æ®çå½æ°

    //åºç¡å°å¾æ°æ®è·å
    function getMapData(fileName){
        d3.json(fileName, function (error, cn) {
            //åºç¡å°å¾æ°æ®çèµå¼
            map_data=cn

            //var parseDate = d3.timeFormat("%Y.%m.%d").parse;
            //æ·»å ç¨äºç¨äºå·éçæ¶é´è½´
            })
    }

    //å°å¾ç¸å³æ°æ®çè·å
    function getStatisticData(fileName){

    }

    //è¿çº¿æ°æ®çè·å
    function getPathData(fileName){
        d3.json(fileName, function (error, move_path) {
            //è¿çº¿æ°æ®çèµå¼
            path_data=move_path
        })
    }

    //å°å¾åå®¹æ°æ®çè·å
    function getComponentData(fileName){
        d3.json(fileName, function (error, components) {
            //console.log(components)
            //å°å¾åå®¹æ°æ®çèµå¼
            web_title=components.web_title
            chinese_title=components.chinese_title
            data_range=components.data_range
            axis_range=components.axis_range
            data_point=components.data_point
            dataSource=components.dataSource
            data_url=components.data_url
            mapSource=components.mapSource
            map_url=components.map_url
            chineses_unit=components.chinese_unit
            num_unit=components.unit
            //æ¯å¦ä¸ºæ¥æåæ°æ®
            is_date=components.is_date_data
            is_rect2axis=components.is_rect2axis
            show_detail=components.show_detail
            //console.log(components)
            //console.log(data_point)
            mapSource=components.mapSource
            dataSource_chinese=components.dataSource_chinese
            show_path=components.show_path

            use_dragBlock=components.use_dragBlock
            use_brush=components.use_brush

            axis_start=axis_range[0];
            axis_end=axis_range[1];
            //å¦ææ¯æ¥æåæ°æ®
            if(is_date==1){
                start_date=axis_range[0]
                axis_start=0;
                axis_end=countGapDays(axis_range[0],axis_range[1]);
            }


            tScale=d3.scaleLinear()
                .domain([axis_start,axis_end])
                .range([0, timelineLen]);
            //console.log(tScale(axis_start))

            })
    }


//è¿è¡ç»å¶çåç§å½æ°
    //ç»å¶å°å¾
    function addMap(){
            svg.selectAll(".state").remove()
            //svg.selectAll(".states").remove()

            //ç»å¶å½å®¶
            svg.append("g")
                .attr("class","state")
                    .selectAll("path")
                    .data(map_data.features)
                    .enter()
                    .append("path")              
                    .attr("d", path)
                    //.attr("class","states")  
                    .attr("fill",function(d,i){
                        if(d.properties.stage=='null'){
                        }
                        else{
                            //return "blue"
                            return color(d.properties.stage)
                            
                        }
                        
                    })
                    .on("mouseover", function (d) {
                        //console.log(d.properties.name)
                        if(d.properties.hasData==1){
                            inmap=1
                            Showmessage(d);

                        }
                        //tooltip.style("display", null);

                    })
                    .on("mouseout", function (d) {
                        if(d.properties.hasData==1){
                            //console.log("outmap")
                            inmap=0
                            setTimeout(function(){
                                if(inmap==0&&intext==0) Regainmessage(d);
                            },100)
                        }
                        tooltip.style("display", "none");
                    });
            d3.select("#southsea").attr("opacity",function(){
                        if(temp_map=="china") return 0.8
                        else return 0
                    });
    }

    //æ·»å åºåçåå­
    function addDistrictName(){
            //ç¨äºé«äº®æ¾ç¤ºçåå­
            d3.selectAll(".mouseover_text_1").remove()
            svg.selectAll(".mouseover_text_1")
                .data(map_data.features)
                .enter().append("text")
                .attr("class","mouseover_text_1")
                .text(function (d) {
                    //console.log(d.id);
                    if(d.properties.cp!=0&&d.properties.hasData==1){
                        return d.properties.name.split(" ")[0];
                    }
                    else return;
                })           
                .attr("fill", "rgba(6,85,178,0.5)")
                .attr("x", function (d) {
                    if(d.properties.cp==0) return 0;
                    if(d.id!=""){
                    var local = proj([d.properties.cp[0], d.properties.cp[1]]);
                    //console.log(local[0]);
                    if(d.id=="VER"){
                            //console.log(local)
                            //console.log("length="+d.properties.name.split(" ")[0].length)
                            //console.log("x="+(local[0]-d.properties.name.split(" ")[0].length*2))
                        }
                    if(isNaN(local[0]-d.properties.name.split(" ")[0].length*2)){
                        //console.log(d.id)
                        //console.log("x="+(local[0]-d.properties.name.split(" ")[0].length*2))
                    }
                    return local[0]-d.properties.name.split(" ")[0].length*2;
                }
                })
                .attr("y", function (d) {
                    if(d.properties.cp==0) return ;
                    if(d.id!=""){
                    var local = proj([d.properties.cp[0], d.properties.cp[1]]);
                    return local[1]+5;
                }
                })
                .attr("dx",function(d,i){
                    return d.properties.dx;

                })
                .attr("dy",function(d,i){              
                    return d.properties.dy
                })
                .attr("font-size", function(d,i){
                    if(d.properties.main_data==1996) return 8*font_scale
                        else return 11*font_scale
                })
                .style("fill-opacity",0)

            d3.selectAll(".mouseover_text_2").remove()
            svg.selectAll(".mouseover_text_2")
                .data(map_data.features)
                .enter().append("text")
                .attr("class","mouseover_text_2")
                .text(function (d) {
                    //console.log(d.id);
                    if(d.properties.cp!=0&&d.properties.hasData==1){
                        return d.properties.name.split(" ")[1];
                    }
                    else return;
                })           
                .attr("fill", "rgba(6,85,178,0.5)")
                .attr("x", function (d) {
                    if(d.properties.cp==0) return ;
                    if(d.id!=""){
                        var local = proj([d.properties.cp[0], d.properties.cp[1]]);
                        //console.log(local[0]);
                        return local[0]-d.properties.name.split(" ")[0].length*2;
                    }
                })
                .attr("y", function (d) {
                    if(d.properties.cp==0) return ;
                    if(d.id!=""){
                    var local = proj([d.properties.cp[0], d.properties.cp[1]]);
                    return local[1]+14;
                }
                })
                .attr("dx",function(d,i){
                    return d.properties.dx;

                })
                .attr("dy",function(d,i){
                    
                        return d.properties.dy
                })
                .attr("font-size", function(d,i){
                    if(d.properties.main_data==1996) return 8*font_scale
                        else return 11*font_scale
                })
                .style("fill-opacity",0)


            //æ·»å å½å®¶åå­
            d3.selectAll(".country_text").remove()
            svg.selectAll(".country_text")
                .data(map_data.features)
                .enter().append("text")
                .attr("class","country_text")
                .text(function (d) {
                    //console.log(d.id);
                    if(d.properties.cp!=0&&d.properties.hasData==1){
                        return d.properties.name.split(" ")[0];
                    }
                    else return;
                })           
                .attr("fill", "rgba(6,85,178,0.5)")
                .attr("x", function (d) {
                    if(d.properties.cp==0) return ;
                    if(d.id!=""){
                    var local = proj([d.properties.cp[0], d.properties.cp[1]]);
                    //console.log(local[0]);
                    return local[0]-d.properties.name.split(" ")[0].length*2;
                }
                })
                .attr("y", function (d) {
                    if(d.properties.cp==0) return ;
                    if(d.id!=""){
                    var local = proj([d.properties.cp[0], d.properties.cp[1]]);
                    return local[1]+5*font_scale;
                }
                })
                .attr("dx",function(d,i){
                    return d.properties.dx;

                })
                .attr("dy",function(d,i){              
                    return d.properties.dy
                })
                .on("mouseover", function (d) {
                        //console.log(d.properties.name)
                        intext=1
                        if(d.properties.hasData==1){
                            if(inmap==0) Showmessage(d);
                        }
                        //tooltip.style("display", null);

                    })
                .on("mouseout", function (d) {
                    intext=0
                        if(d.properties.hasData==1){
                            setTimeout(function(){
                                if(inmap==0&&intext==0) Regainmessage(d);
                            },100)
                        }
                        //tooltip.style("display", "none");
                })
                .attr("font-size", function(d,i){
                    if(d.properties.main_data==1996) return 8*font_scale
                        else return 11*font_scale
                })
                .attr("fill-opacity",1)
                .attr("opacity",1)


            d3.selectAll(".country_text2").remove()
            svg.selectAll(".country_text2")
                .data(map_data.features)
                .enter().append("text")
                .attr("class","country_text2")
                .text(function (d) {
                    //console.log(d.id);
                    if(d.properties.cp!=0&&d.properties.hasData==1){
                        return d.properties.name.split(" ")[1];
                    }
                    else return;
                })           
                .attr("fill", "rgba(6,85,178,0.5)")
                .attr("x", function (d) {
                    if(d.properties.cp==0) return ;
                    if(d.id!=""){
                    var local = proj([d.properties.cp[0], d.properties.cp[1]]);
                    //console.log(local[0]);
                    return local[0]-d.properties.name.split(" ")[0].length*2;
                }
                })
                .attr("y", function (d) {
                    if(d.properties.cp==0) return ;
                    if(d.id!=""){
                    var local = proj([d.properties.cp[0], d.properties.cp[1]]);
                    return local[1]+14*font_scale;
                }
                })
                .attr("dx",function(d,i){
                    return d.properties.dx;

                })
                .attr("dy",function(d,i){
                    
                        return d.properties.dy
                })
                .on("mouseover", function (d) {
                        //console.log(d.properties.name)
                        intext=1
                        if(d.properties.hasData==1){
                            if(in_map==0) Showmessage(d);
                        }
                        //tooltip.style("display", null);

                    })
                    .on("mouseout", function (d) {
                        intext=0
                        if(d.properties.hasData==1){
                            setTimeout(function(){
                                if(inmap==0&&intext==0) Regainmessage(d);
                            },100)
                        }
                        //tooltip.style("display", "none");
                    })
                .attr("font-size", function(d,i){
                    if(d.properties.main_data==1996) return 8*font_scale
                        else return 11*font_scale
                })
                .attr("fill-opacity",1)
                .attr("opacity",1)

            d3.selectAll(".country_num_text").remove()

            if(show_detail==0){
                return true
            }

            svg.selectAll(".country_num_text")
                .data(map_data.features)
                .enter().append("text")
                .attr("class","country_num_text")
                .text(function (d) {
                    //console.log(d.id);
                    if(d.properties.cp!=0&&d.properties.hasData==1){
                        let temp_data=""
                        if(is_rect2axis==0) temp_data=d.properties.main_data[axis_end]
                            else temp_data=d.properties.main_data
                        return temp_data
                    }
                    else return;
                })
                .attr("x", function (d) {
                    if(d.properties.cp==0) return ;
                    if(d.id!=""){
                    var local = proj([d.properties.cp[0], d.properties.cp[1]]);
                    //console.log(local[0]);
                    return local[0]//-d.properties.name.split(" ")[0].length*0.5*font_scale;
                }
                })
                .attr("y", function (d) {
                    if(d.properties.cp==0) return ;
                    if(d.id!=""){
                    var local = proj([d.properties.cp[0], d.properties.cp[1]]);
                    if (d.properties.name.split(" ").length==1) return local[1]+18*font_scale;
                    else return local[1]+28*font_scale;
                }
                })
                .attr("mouseover",function(){
                    intext=1
                })
                .attr("mouseout",function(){
                    intext=0
                })
                .style("text-anchor","middle")
                .attr("dx",function(d,i){
                    return d.properties.dx;

                })
                .attr("dy",function(d,i){
                    
                        return d.properties.dy
                })
                .attr("font-size", function(d,i){
                    if(d.properties.main_data==1996) return 12*font_scale
                        else return 12*font_scale
                })
                .style("font-family","Khand-Regular")
                .style("font-weight","bold")
                .attr("fill-opacity",1)
                .attr("opacity",1)                         
                .attr("fill", "rgba(247,254,174,0.9)")
    }

    //æ·»å åºåçå³èæ°æ®ï¼é¢è²ãè¯¦ç»ä¿¡æ¯ç­ï¼
    function addMapStatistic(){
        //æ·»å å¸®å©æ¾ç¤ºå½å®¶çrect
            d3.selectAll(".viewrect").remove()
            var coutry_box=svg.append("rect")
                .attr("class","viewrect")
                .attr("width",width/20)
                .attr("height",height/20)
                .style("fill","white")
                .style("fill-opacity",.0)
    }

    //æ·»å æ¶é´è½´/èå´è½´ ä»¥å å³é®äºä»¶
    function addAxis(){

            let tAxis = d3.axisRight(tScale)
                .ticks(10)
                //.tickValues()
                .tickFormat(function(v) { // æ ¼å¼åå»åº¦å¼
                    return ""
                        //if(v==0) return v;
                        //if(v==1900||v==1950||v==2000) return v;
                 });


            svg.select(".axis").remove()
            var time_axis=svg.append("g")
                    .attr("class","axis")
                    .attr("transform","translate(" +(timelineX) + "," +(timelineY) + ")")
                    .call(tAxis);
            //å³é®äºä»¶
            svg.selectAll(".point_text").remove()
            var point_text=svg.selectAll(".point_text")
                    .data(data_point)
                    .enter()
                    .append("text")
                    .attr("class","point_text")
                    .attr("font-size",10*font_scale)
                    .attr("x",function(d,i){
                        if (d.event.split(":").length==2) return timelineX+width*0.045;
                        return timelineX+width*0.022;
                     })
                    .attr("y",function(d,i){
                        let temp_data=d.year
                        if(is_date==1) temp_data=countGapDays(start_date,temp_data)
                        if (d.event.split(":").length==2) return timelineY+tScale(temp_data)+height*0.007*3
                        return timelineY+tScale(temp_data)+height*0.007
                    })
                    .text(function(d,i){
                        if (d.event.split(":").length==2) return d.event.split(":")[1]
                        return d.year+num_unit+": "+d.event;
                    })
                    //.attr("fill","white")
                    .style("fill-opacity",.9);
            d3.selectAll(".point_line").remove()
            var line=svg.selectAll(".point_line")
                .data(data_point)
                .enter()
                .append("path")
                .attr("class","point_line")
                .attr("d",function(d,i){
                    let temp_data=d.year
                    if(is_date==1) temp_data=countGapDays(start_date,temp_data)
                    return "M"+(timelineX)+","+(timelineY+tScale(temp_data))+" L"+(timelineX+width*0.02)+","+(timelineY+tScale(temp_data))

                })
                .attr("stroke","red")
                .attr("stroke-dasharray","5,5")
            //å·éæ¡
            if(use_brush==1){
                let brush=d3.brushY()
                    .extent([[timelineX-width/60, timelineY], [timelineX, timelineY+timelineLen]])
                    .on("brush end", display);
                svg.select(".brush").remove()
                svg.append("g")
                    .attr("class", "brush")
                    .call(brush)
                    .call(brush.move, [timelineY,timelineY+timelineLen]);
            }
            
            if(use_dragBlock==1) addDragBlock()
    }

    //æ·»å è¿çº¿åcircle
    function addPath(hasPath){
        if(hasPath==false){
            d3.selectAll(".links").remove()
            d3.selectAll(".mycircle").remove()
            return
        }
        var defs = svg.append("defs");
            //ç®­å¤´maker
            var arrowMarker = defs.append("marker")
                            .attr("id","arrow")
                            .attr("markerUnits","strokeWidth")
                            .attr("markerWidth","7")
                            .attr("markerHeight","7")
                            .attr("viewBox","0 0 10 10") 
                            .attr("refX","6")
                            .attr("refY","6")
                            .attr("orient","auto");

            var arrow_path = "M2,2 L10,6 L2,10 L6,6 L2,2";
                            
            arrowMarker.append("path")
                .attr("d",arrow_path)
                .attr("fill","white")
                .attr("fill-opacity",0.7);
            //è¿ç§»è¿ç¨æ²çº¿
            // filters go in defs element
            var defs = svg.append("defs");

            // create filter with id #drop-shadow
            // height=130% so that the shadow is not clipped
            var filter = defs.append("filter")
                .attr("id", "drop-shadow")
                .attr("height", "140%");

            // SourceAlpha refers to opacity of graphic that this filter will be applied to
            // convolve that with a Gaussian with standard deviation 3 and store result
            // in blur
            filter.append("feGaussianBlur")
                .attr("in", "SourceAlpha")
                .attr("stdDeviation", 4)
                .attr("result", "blur");

            // translate output of Gaussian blur to the right and downwards with 2px
            // store result in offsetBlur
            filter.append("feOffset")
                .attr("in", "blur")
                .attr("dx", 5)
                .attr("dy", 6)
                .attr("result", "offsetBlur");

            // overlay original SourceGraphic over translated blurred opacity by using
            // feMerge filter. Order of specifying inputs is important!
            var feMerge = filter.append("feMerge");

            feMerge.append("feMergeNode")
                .attr("in", "offsetBlur")
            feMerge.append("feMergeNode")
                .attr("in", "SourceGraphic");

            d3.selectAll(".links").remove()
            var country_link=svg.selectAll(".links")
                    .data(path_data)
                    .enter()
                    .append("path")
                    .attr("class","links")
                    .attr("d", function(d){
                        if(d.source.name=="Russia"||d.target.name=="Tanzania") return link_2(d)
                        if(d.source.name=="Angola") return link_3(d)
                        return link(d)
                    })
                 .attr("marker-end","url(#arrow)")
                 /*.style("fill",function(d,i){
                    if(d.source.name=="Kenya") return "rgb(160,160,160)"
                 })*/
                 .attr("filter", function(d){
                    if(Math.abs(d.target.x-d.source.x)>15&&d.source.name!="Portugal") return "url(#drop-shadow)";
                })
                 .attr("fill",function(d){
                    if(Math.abs(d.target.x-d.source.x)<15||d.source.name=="Portugal") return "black"

                 })
                 .on("mouseover",function(){
                    //console.log("inline")
                    inline=1;
                 })
                 .on("mouseout",function(){
                    inline=0;
                 })
                 .attr("fill-opacity",0.06)
                 .attr("stroke-opacity",0.8)
                 .style("opacity",function(){
                    return show_path
                 });

            d3.selectAll(".mycircle").remove()
            var circles=svg.selectAll(".mycircle")
                    .data(path_data)
                    .enter()
                    .append("circle")
                    .attr("class","mycircle")
                    .attr("r",6*font_scale)
                    .attr("cx",function(d,i){
                        maploc=proj([d.source.x, d.source.y])
                        return maploc[0];
                    })
                    .attr("cy",function(d,i){
                        maploc=proj([d.source.x, d.source.y])
                        return maploc[1];

                    })
                    /*
                    .on("mouseover",function(d){

                        Showmessage(d);
                    })
                    .on("mouseout",function(d){
                        Regainmessage(d)
                    })*/
                    .on("mouseover", function (d) {
                        inmap=1

                    })
                    .on("mouseout", function (d) {
                        
                    })
                    .attr("fill","rgb(247,254,174)")
                    .style("opacity",function(){
                        return show_path
                    })
    }

    //æ·»å èå´ç©éµ
    function addRangeRect(){
            let rect_width=width/16
            /*for(var i=0;i<data_range.length;i++){
                let range_name_width=data_range[i].name.length*font_scale*7
                if(range_name_width>rect_width) rect_width=range_name_width
            }*/
            var rect_scale=height/27
            var dx_rect=-rect_width-width/32
            //console.log(data_range)

            d3.selectAll(".range_rect").remove()

            var rect=svg.selectAll(".range_rect")
                .data(data_range)
                .enter()
                .append("rect")
                .attr("class","range_rect")
                .attr("transform","translate(" + 0+ "," +0 + ")")
                .attr("x",function(d,i){
                    return timelineX+dx_rect
                })
                .attr("y",function(d,i){
                    //return 30+i*(rect_scale+10);
                    if(is_rect2axis==0) return timelineY+21*i
                    if(is_date==1){
                        return tScale(countGapDays(start_date,d.range[0]))+timelineY
                    }
                    return tScale(d.range[0])+timelineY
                })
                .attr("width",function(d,i){
                    return rect_width;
                })
                .attr("height",function(d){
                    if(is_rect2axis==0) return 20
                    if(is_date==1){
                        return tScale(countGapDays(start_date,d.range[1]))-tScale(countGapDays(start_date,d.range[0]))
                    }
                    return tScale(d.range[1])-tScale(d.range[0])
                })
                .attr("fill",function(d,i){ 
                    return color(d.id)
                })
                .style("stroke","white")
                .style("stroke-opacity",0.6)
                .on("mouseover",function(d,i){
                    Highlight(d);

                })
                .on("mouseout",function(d,i){
                    if(d.id==4) Regain(d);

                });

            d3.selectAll(".range_name").remove()
            var text=svg.selectAll(".range_name")
                    .data(data_range)
                    .enter()
                    .append("text")
                    .attr("class","range_name")
                    .attr("font-size",function(d){
                        if(d.name.length*font_scale*7>rect_width) return (rect_width*1.8/d.name.length)
                        else return 12*font_scale
                    })
                    .attr("transform","translate(" + rect_width*0.05+ "," +0 + ")")
                    .on("mouseover",function(d,i){
                    Highlight(d);

                })
                .on("mouseout",function(d,i){
                    if(d.id==4) Regain(d);

                })
                .attr("x",function(d,i){
                    return timelineX+dx_rect;
                 })
                .attr("y",function(d,i){
                    if(is_rect2axis==0) return timelineY+21*i+10
                    if(is_date==1) return tScale(countGapDays(start_date,d.range[0]))+timelineY+rect_scale*3/5
                    return tScale(d.range[0])+timelineY+rect_scale*3/5
                })
                .text(function(d,i){
                    return ""+d.name;
                })

    }

    //æ·»å æ é¢ãæ°æ®æ¥æºç­
    function addOtherInfo(){
            //æ·»å title
            
            d3.selectAll(".shadow_title").remove()         
            var shadow_text=svg.append("text")
                      .attr("x",width*0.02)
                      .attr("y",height*0.05)
                      .attr("class", "shadow shadow_title")
                      .attr("font-size",20*font_scale)
                      .text(web_title);
            d3.selectAll(".title").remove()  
            var title=svg.append("text")
                                .attr("class","title")
                                .attr("x",width*0.02)
                                .attr("y",height*0.05)
                                .attr("font-size",20*font_scale)
                                .text(web_title)
            //æ·»å æ°æ®æ¥æº
            d3.selectAll(".source_text").remove() 
            let data_source=svg.append("text")
                .attr("class","source_text source1")
                .attr("x",width*0.01)
                .attr("y",(height*0.97))
                .attr("font-size",11*font_scale)
                .text("Data Source: "+dataSource)
                .on("mouseover",function(d){
                    data_source.style("fill","white")

                })
                .on("mouseout",function(){
                    data_source.style("fill","rgb(80,80,80)")
                })
                .on("click",function(){
                    window.open("http://www.fao.org");
                })

            let map_source=svg.append("text")
                .attr("class","source_text source2")
                .attr("x",width*0.01)
                .attr("y",height*0.99)
                .attr("font-size",11*font_scale)
                .text("Map Source: github.com/johan/world.geo.json")
                .on("mouseover",function(d){
                    map_source.style("fill","white")

                })
                .on("mouseout",function(){
                    map_source.style("fill","rgb(80,80,80)")
                })
                .on("click",function(){
                    window.open("https://github.com/johan/world.geo.json");
                })

            //å·éä»¥åæ­æ¾å¨ç»æ¶æ¾ç¤ºçèå´
            d3.selectAll(".range_text").remove()
            var range_text=svg.append("text")
                        .attr("class","range_text")
                        .attr("x",timelineX)
                        .attr("y",timelineY+timelineLen+height/25)
                        .text(axis_start+"-"+axis_end)
                        .attr("font-size",18*font_scale)
                        .style("text-anchor","middle")
                        .attr("fill","white")
                        .attr("opacity",1)
    }

    //æ·»å æ­æ¾æé®
    function addPlayButton(hasButton){
            d3.selectAll(".button_circle").remove()
            d3.selectAll(".button_stop").remove()
            d3.selectAll(".button_rect").remove()
        if(hasButton==false){
            return
        }
        button_center=[width*8/9,height*5/6]
            button_r=height/22

            var button_circle=svg.append("circle")
            .attr("class","button_circle")
              .attr("r", button_r)
              .attr("cx", button_center[0])
              .attr("cy",button_center[1])
              .on("click",function(d){
                //d3.selectAll(".button_stop").attr("fill-opacity",1);
                //button_stop.style("fill-opacity",1)
                //button_rect.style("fill-opacity",0)
                play_flag=(1-play_flag)
                if(play_flag==0){
                        d3.selectAll(".button_stop")
                            .attr("fill-opacity",0)
                         d3.selectAll(".button_rect")
                            .attr("fill-opacity",1)
                    }
                    else{
                        d3.selectAll(".button_stop")
                            .attr("fill-opacity",1)
                         d3.selectAll(".button_rect")
                            .attr("fill-opacity",0)
                    }
                console.log("circe "+play_flag)
                console.log("isEnd "+isEnd)
                if(isEnd==1){
                    isEnd=0;
                    play_flag=1;
                    console.log("isEnd "+isEnd)
                    console.log("start")
                    show_process(axis_start,axis_end);}
                //console.log(stop_year)
              })
              .attr("stroke","rgb(220,220,220)")
              .attr("stroke-width",3)
              .attr("fill","rgb(100,100,100)")
              .style("fill-opacity",0.8);
            var button_stop=svg.append("rect")
                .attr("class","button_stop")
                .attr("x",button_center[0]-button_r*2/5)
                .attr("y",button_center[1]-button_r/2)
                .attr("width",button_r/5)
                .attr("height",button_r)
                .attr("fill","rgb(240,240,240)")
                .attr("fill-opacity",0)
                .on("click",function(d){
                    //d3.selectAll(".button_stop").attr("fill-opacity",1);
                    //button_stop.style("fill-opacity",1)
                    //button_rect.style("fill-opacity",0)
                    play_flag=(1-play_flag)
                    console.log("rect "+play_flag)
                    if(play_flag==0){
                        d3.selectAll(".button_stop")
                            .attr("fill-opacity",0)
                         d3.selectAll(".button_rect")
                            .attr("fill-opacity",1)
                    }
                    else{
                        d3.selectAll(".button_stop")
                            .attr("fill-opacity",1)
                         d3.selectAll(".button_rect")
                            .attr("fill-opacity",0)
                    }
                    if(isEnd==1){
                    isEnd=0;
                    play_flag=1;
                    show_process(axis_start,axis_end);}
              })

            var button_stop2=svg.append("rect")
                .attr("class","button_stop")
                .attr("x",button_center[0]+button_r/5)
                .attr("y",button_center[1]-button_r/2)
                .attr("width",button_r/5)
                .attr("height",button_r)
                .attr("fill","rgb(240,240,240)")
                .attr("fill-opacity",0)
                .on("click",function(d){
                    //d3.selectAll(".button_stop").attr("fill-opacity",1);
                    //button_stop.style("fill-opacity",1)
                    //button_rect.style("fill-opacity",0)
                    play_flag=(1-play_flag)
                    console.log("rect "+play_flag)
                    if(play_flag==0){
                        d3.selectAll(".button_stop")
                            .attr("fill-opacity",0)
                         d3.selectAll(".button_rect")
                            .attr("fill-opacity",1)
                    }
                    else{
                        d3.selectAll(".button_stop")
                            .attr("fill-opacity",1)
                         d3.selectAll(".button_rect")
                            .attr("fill-opacity",0)
                    }
                    if(isEnd==1){
                    isEnd=0;
                    play_flag=1;
                    show_process(axis_start,axis_end);}
              })

            var button_rect=svg.append("path")
                .attr("class","button_rect")
                .attr("d","M "+(button_center[0]+button_r/2)+","+(button_center[1])+" L"
                    +(button_center[0]-button_r/3)+","+(button_center[1]-button_r/2)+" L"
                    +(button_center[0]-button_r/3)+","+(button_center[1]+button_r/2))
                .attr("fill","rgb(240,240,240)")
                .on("click",function(d){
                    //d3.selectAll(".button_stop").attr("fill-opacity",1);
                    //button_stop.style("fill-opacity",1)
                    //button_rect.style("fill-opacity",0)
                    play_flag=(1-play_flag)
                    if(play_flag==0){
                        d3.selectAll(".button_stop")
                            .attr("fill-opacity",0)
                         d3.selectAll(".button_rect")
                            .attr("fill-opacity",1)
                    }
                    else{
                        d3.selectAll(".button_stop")
                            .attr("fill-opacity",1)
                         d3.selectAll(".button_rect")
                            .attr("fill-opacity",0)
                    }
                    console.log("san "+play_flag)
                    if(isEnd==1){
                        isEnd=0;
                    play_flag=1;
                    show_process(axis_start,axis_end);}
              })
    }

    function addDragBlock(){
        let slipBlockWidth=26*font_scale
        let slipBlockHeight=12*font_scale
        let dragFun = function () {
          // è·å¾è¢«ç¹å»åç´ class
          var className = d3.select(this).attr('class');
          // è®¡ç®é¼ æ xåæ ï¼è¦åå»æ»åå®½åº¦çäºåä¹ä¸
          var pos = d3.event.y - slipBlockHeight / 2;
          // è®¡ç®é¼ æ indexï¼
          //var index = getIndex(pos);

          // æ»ååªè½å¨0å°maxIndexä¹é´æ»å¨ï¼å³ä¸å±æ¨ªæ¡å
            if (pos >= timelineY-slipBlockHeight/2 && pos <= timelineY+timelineLen-slipBlockHeight/2) {
                    // ç§»å¨å·¦æ»ååç¸å³èæ¯åæå­å°é¼ æ ä½ç½®
                    d3.select(".slide_rect")
                        .attr("y",pos)
                    let temp_gap=d3.event.y-timelineY+slipBlockHeight/2
                    if(is_date==1){
                        temp_time=parseInt(countDate(axis_start,Math.round(temp_gap*(axis_end-axis_start)/timelineLen)).replaceAll("/",""));
                    }
                    else{
                        temp_time=axis_start+parseInt(temp_gap*(axis_end-axis_start)/timelineLen);  
                    }
                    //console.log(temp_time)
                    change_to_timerange(axis_start.toString(),temp_time)

            }
            }
            // æ»åæå¨
            var slipBlockDrag = d3.drag()
                  .on('drag', dragFun);
            // æ»ååç´ è°ç¨ææ½æ¹æ³
            let slipBlock=svg.append("rect")
                .attr("class","slide_rect")
                .attr("width",slipBlockWidth)
                .attr("height",slipBlockHeight)
                .attr("x",timelineX-slipBlockWidth/2)
                .attr("y",timelineY+timelineLen-slipBlockHeight/2)
                .attr("fill","rgb(160,160,160)")
                .attr("stroke","white")
                .attr("stroke-width",2*font_scale)
                .attr("pointer","cursor")
                .style("opacity",0.7)
            temp_time=axis_end.toString()
            d3.selectAll(".range_text")
                .text(temp_time)
            slipBlock.call(slipBlockDrag);
    }


//ç»æç»å¶ï¼å¼å§åç§å½æ°äº
    
    //é«äº®
    function Highlight(temp_range){
            //æ¹åå½å®¶çé¢è²æ¾ç¤º
            d3.select(".state")
                .selectAll("path")
                .transition().duration(500)
                .attr("fill",function(d){
                    //console.log(d)
                    //console.log(2333)

                    if(d.properties.stage<=temp_range.id){
                        return color(d.properties.stage)
                    }
                    
                });
            //æ¹åè¿çº¿çæ¾ç¤º
            d3.selectAll(".links")
                .style("stroke-width",function(d,i){
                    //console.log(d)
                    if(d.stage==temp_range.id){
                        return 2*font_scale;
                    }
                    else{
                        return 0
                    }
                })
                .style("fill",function(d){
                if((Math.abs(d.target.x-d.source.x)<15||d.source.name=="Portugal")&&d.stage==temp_range.id) return "black"

             })
            //æ¹åå½å®¶åå­çæ¾ç¤º
            d3.selectAll(".country_text")
                .style("fill-opacity",function(d,i){
                    if(d.properties.stage==temp_range.id){
                        return 
                    }
                    else{
                        return 0.2
                    }
                })
            d3.selectAll(".country_text2")
                .style("fill-opacity",function(d,i){
                    if(d.properties.stage==temp_range.id){
                        return 
                    }
                    else{
                        return 0.2
                    }
                })
            //æ¹åä¼ æ­å°çååçéæåº¦
           d3.selectAll(".mycircle")
            .attr("r",function(d,i){
                if(d.stage==temp_range.id){
                        return 10*font_scale
                    }
                    else{
                        return 0.1
                    }
            })
            .style("fill-opacity",function(d,i){
                if(d.stage==temp_range.id) return 0.8
                    else return 0.1
            }) 
        }

        //æ¢å¤
        function Regain(temp_range){
            d3.select(".state")
                .selectAll("path")
            .attr("fill",function(d,i){
                        //console.log(d)
                        if(d.properties.stage=='null'){
                        }
                        else{
                            return color(d.properties.stage)
                        }
                    });
            //æ¹åè¿çº¿çæ¾ç¤º
            d3.selectAll(".links")
                .style("stroke-width",function(d,i){
                })
                .style("fill",function(d){
                if((Math.abs(d.target.x-d.source.x)<15||d.source.name=="Portugal")&&d.stage==temp_range.id) return "black"

             })

            //æ¹åå½å®¶åå­çæ¾ç¤º
            d3.selectAll(".country_text")
                .style("fill-opacity",function(d,i){
                    return 
                })
            d3.selectAll(".country_text2")
                .style("fill-opacity",function(d,i){
                    return 
                })

                //æ¹åä¼ æ­å°çååçéæåº¦
           d3.selectAll(".mycircle")
            .attr("r",function(d,i){
                return 6*font_scale
            })
            .style("fill-opacity",function(d,i){
                return .4
            }) 

        }

    //å¤æ­ä¸¤ä¸ªå°åºæ¯å¦æå³è
    function hasRelation(a,b){

        for(var i=0;i<path_data.length;i++){
            //console.log(path_data[i].source.name)
            if(path_data[i].source.name==a.properties.name&&path_data[i].target.name==b.properties.name) return 1;
            if(path_data[i].source.name==b.properties.name&&path_data[i].target.name==a.properties.name) return 1;
        }
        return 0;
    }

    //å·éå±ç¤ºå½æ°
    function display(){
        if(brush_flag<2){
            brush_flag+=1
            return
        }
        if(d3.event.selection==null){
            d3.selectAll(".states")//.selectAll("path")
            .style("fill",function(d,i){
                    //console.log(d)
                    if(d.properties.stage=='null'){
                        return "rgb(160,160,160)"
                    }
                    else{
                        return color(d.properties.stage)
                    }
                });

        d3.selectAll(".range_text")
            .style("fill","none")

            d3.selectAll(".country_text")
                .style("fill-opacity",function(d){
                    return .9
                })
            d3.selectAll(".country_text2")
                .style("fill-opacity",function(d){
                    return .9
                })
            d3.selectAll(".links")
                .style("stroke-width",function(d){
                        return 
                })
                .style("fill",function(d){
                if((Math.abs(d.target.x-d.source.x)<15||d.source.name=="Portugal")){
                    return "black"
                }
                })
            d3.selectAll(".mycircle")
                .attr("r",function(d,i){
                            return 6*font_scale

                })
                .style("fill-opacity",function(d,i){
                    return 0.4
                })

            return

        } 
        let s = d3.event.selection;
        //console.log(s)
        let s_0=s[0]-timelineY;
        let s_1=s[1]-timelineY;
        //console.log(s_0)
        //console.log(countDate(axis_start,parseInt(s_0*(axis_end-axis_start)/timelineLen)))
        if(is_date==1){
            year_0=parseInt(countDate(axis_start,parseInt(s_0*(axis_end-axis_start)/timelineLen)).replaceAll("/",""));
            year_1=parseInt(countDate(axis_start,parseInt(s_1*(axis_end-axis_start)/timelineLen)).replaceAll("/",""));
        }
        else{
            year_0=axis_start+parseInt(s_0*(axis_end-axis_start)/timelineLen);
            year_1=axis_start+parseInt(s_1*(axis_end-axis_start)/timelineLen);    
        }
        console.log([year_0,year_1])

        change_to_timerange(year_0,year_1)



    }

    function change_to_timerange(year_0,year_1){
        d3.selectAll(".country_num_text")
            .text(function(d){
                if(is_rect2axis==0){
                            let num0=0
                            if(year_0!=axis_start){
                                let pre_date=countDate(axis_start,countGapDays(axis_start,parseInt(year_0))-1).replaceAll("/","")
                                num0=d.properties.main_data[pre_date]
                            }
                            let num1=d.properties.main_data[year_1.toString()]
                            let brush_num=num1-num0
                            if(isNaN(num1-num0)||num1-num0==0) return ""
                                else return num1-num0
                    }
            })
            .style("opacity",1)
        d3.select(".state")
            .selectAll("path")
            .attr("fill",function(d,i){
                    //console.log(d)
                    if(d.properties.stage=='null') return "rgb(160,160,160)"
                    if(is_rect2axis==0){
                            let num0=0
                            if(parseInt(year_0)!=axis_start){
                                let pre_date=countDate(axis_start,countGapDays(axis_start,parseInt(year_0))-1).replaceAll("/","")
                                num0=d.properties.main_data[pre_date]
                            }
                            let num1=d.properties.main_data[year_1.toString()]
                            let brush_num=num1-num0
                            if(d.properties.chinese_name=="ä¸­å½") console.log(num1-num0)
                            for(var k=0;k<data_range.length;k++){
                                if(brush_num<=data_range[k].range[1]&&brush_num>=data_range[k].range[0]) return color(k)
                            }

                    }
                    else if(is_date==1){
                        let temp_gap_days=countGapDays(start_date,d.properties.main_data)
                        if(temp_gap_days>=year_0&&temp_gap_days<=year_1){
                            return color(d.properties.stage)
                        }
                    }
                    else if(d.properties.main_data.length==5){
                        temp_year=parseInt(d.properties.main_data.substr(0,4))
                        if(temp_year>=year_0&&temp_year<=year_1){
                            //return color(4)
                            return color(d.properties.stage)
                        }
                    }
                    else if(d.properties.main_data>=year_0&&d.properties.main_data<=year_1){
                        //return color(4)
                        return color(d.properties.stage)
                    }                 
                    else return "rgb(160,160,160)"
                });
        d3.selectAll(".country_text")
                .style("fill-opacity",function(d){
                    if(is_rect2axis==0){
                            let num0=0
                            if(parseInt(year_0)!=axis_start){
                                let pre_date=countDate(axis_start,countGapDays(axis_start,parseInt(year_0))-1).replaceAll("/","")
                                num0=d.properties.main_data[pre_date]
                            }
                            let num1=d.properties.main_data[year_1.toString()]
                            let brush_num=num1-num0
                            //console.log(num1-num0)
                            for(var k=0;k<data_range.length;k++){
                                if(brush_num<=data_range[k].range[1]&&brush_num>=data_range[k].range[0]) return .9
                            }
                        return 0

                    }
                    let temp_data=d.properties.main_data
                    if(is_date==1) temp_data=countGapDays(start_date,temp_data)
                    if(temp_data>=year_0&&temp_data<=year_1){
                        return .9
                    }
                    else return 0
                })
        d3.selectAll(".country_text2")
                .style("fill-opacity",function(d){
                    if(is_rect2axis==0){
                        let num0=d.properties.main_data[year_0.toString()]
                        let num1=d.properties.main_data[year_1.toString()]
                        let brush_num=num1-num0
                        //console.log(num1-num0)
                        for(var k=0;k<data_range.length;k++){
                            if(brush_num<=data_range[k].range[1]&&brush_num>=data_range[k].range[0]) return .9
                        }
                        return 0

                    }
                    let temp_data=d.properties.main_data
                    if(is_date==1) temp_data=countGapDays(start_date,temp_data)
                    if(temp_data>=year_0&&temp_data<=year_1){
                        return .9
                    }
                    else return 0
                })
        d3.selectAll(".range_text")
            .text(function(){
                if(use_dragBlock==1){
                        return year_1

                }
                else if(is_date==1) return year_0+"-"+year_1
                return parseInt(year_0)+"-"+parseInt(year_1)
            })
            .style("fill","white")
            .attr("opacity",1)
        if(hasPath==0) return true

        d3.selectAll(".links")
                .style("stroke-width",function(d){
                    if(is_rect2axis==0){
                        return 0
                            let num0=d.properties.main_data[year_0.toString()]
                            let num1=d.properties.main_data[year_1.toString()]
                            let brush_num=num1-num0
                            //console.log(num1-num0)
                            for(var k=0;k<data_range.length;k++){
                                if(brush_num<=data_range[k].range[1]&&brush_num>=data_range[k].range[0]) return 2.3
                            }
                        return 0

                    }
                    let temp_data=d.main_data
                    //if(is_date==1) temp_data=countGapDays(start_date,temp_data)
                    if(temp_data>=year_0&&temp_data<=year_1){
                        return 2.3
                    }
                    else return 0
                })
                .style("fill",function(d){
                    if(is_rect2axis==0){
                        return 
                            let num0=d.properties.main_data[year_0.toString()]
                            let num1=d.properties.main_data[year_1.toString()]
                            let brush_num=num1-num0
                            //console.log(num1-num0)
                            for(var k=0;k<data_range.length;k++){
                                if(brush_num<=data_range[k].range[1]&&brush_num>=data_range[k].range[0]) return ""
                            }

                    }
                    let temp_data=d.main_data
                        //if(is_date==1) temp_data=countGapDays(start_date,temp_data)
                    if((Math.abs(d.target.x-d.source.x)<15||d.source.name=="Portugal")){
                        if(temp_data>=year_0&&temp_data<=year_1) return "black"
                    }
                })
        d3.selectAll(".mycircle")
                .attr("r",function(d,i){
                    if(is_rect2axis==0){
                        return 0
                            let num0=d.properties.main_data[year_0.toString()]
                            let num1=d.properties.main_data[year_1.toString()]
                            let brush_num=num1-num0
                            //console.log(num1-num0)
                            for(var k=0;k<data_range.length;k++){
                                if(brush_num<=data_range[k].range[1]&&brush_num>=data_range[k].range[0]) return 6*font_scale
                            }
                        return 0

                    }
                    let temp_data=d.main_data
                    //if(is_date==1) temp_data=countGapDays(start_date,temp_data)
                    if(temp_data<year_1&&temp_data>year_0){
                            return 6*font_scale
                    }
                    else{
                        return 0
                    }
                })
                .style("fill-opacity",function(d,i){
                    if(is_rect2axis==0){
                        return 0
                            let num0=d.properties.main_data[year_0.toString()]
                            let num1=d.properties.main_data[year_1.toString()]
                            let brush_num=num1-num0
                            //console.log(num1-num0)
                            for(var k=0;k<data_range.length;k++){
                                if(brush_num<=data_range[k].range[1]&&brush_num>=data_range[k].range[0]) return 6*font_scale
                            }
                        return 0

                    }
                    let temp_data=d.main_data
                    //if(is_date==1) temp_data=countGapDays(start_date,temp_data)
                    if(temp_data<year_1&&temp_data>year_0) return 0.4
                        else return 0
                })
    }

    //éæ©å½å®¶æ¾ç¤ºè¯¦ç»ä¿¡æ¯
    function Showmessage(temp_country){

        dx_remark=width/33
        dy_remark=height/14
        //æ¹åå½å®¶çé¢è²æ¾ç¤º
        d3.select(".state")
            .selectAll("path")
            .transition().duration(300)
            .attr("fill",function(d){
                //console.log(d)
                //console.log(2333)

                if(use_dragBlock==1 && temp_country.properties.main_data[temp_time.toString()]==0) return "rgb(160,160,160)"

                else if(hasRelation(d,temp_country)==1||d.properties.name==temp_country.properties.name){
                    if(use_dragBlock==1){
                            let num0=0
                            let num1=d.properties.main_data[temp_time.toString()]
                            let brush_num=num1-num0
                            if(d.properties.chinese_name=="ä¸­å½") console.log(num1-num0)
                            for(var k=0;k<data_range.length;k++){
                                if(brush_num<=data_range[k].range[1]&&brush_num>=data_range[k].range[0]) return color(k)
                            }
                    }
                    else return color(d.properties.stage)
                }
                else{
                    return "rgb(160,160,160)"
                }
                
            });

        
        //
        d3.selectAll(".viewrect")
            .attr("x", function () {
                if(temp_country.id!=""){
                var local = proj([temp_country.properties.cp[0], temp_country.properties.cp[1]]);
                //console.log(local[0]);
                return local[0]-temp_country.properties.name.split(" ")[0].length*3*font_scale+temp_country.properties.dx+dx_remark;
            }
            })
            .attr("y", function () {
                if(temp_country.id!=""){
                var local = proj([temp_country.properties.cp[0], temp_country.properties.cp[1]]);
                if(temp_country.properties.name=="Tanzania"||temp_country.properties.name=="Cuba"||temp_country.properties.name=="Portugal"||temp_country.properties.name=="Ivory Coast") return local[1]-dy_remark*1/3+temp_country.properties.dy
                return local[1]-dy_remark+temp_country.properties.dy;
            }
            })
            .attr("width",function(){
                let detail_text=""
                    if(is_rect2axis==0){
                        detail_text+=("case:"+temp_country.properties.main_data[axis_end.toString()]+" ")
                        detail_text+=("cured:"+temp_country.properties.cure_data[axis_end.toString()]+" ")                      
                        detail_text+=("dead:"+temp_country.properties.death_data[axis_end.toString()]+" ")
                    }
                        else detail_text=temp_country.properties.main_data
                let temp_scale=0.7
                if(temp_lan=="chinese"){
                    return (temp_country.properties.chinese_name.length*font_scale*19+(detail_text.length)*font_scale*9.5)*temp_scale
                }
                if(temp_country.properties.main_data.length==5) return (temp_country.properties.name.split(" ")[0].length+5 )*width/115*temp_scale;
                if(is_rect2axis==1) return (temp_country.properties.name.split(" ")[0].length+temp_country.properties.main_data.toString().length)*font_scale*9.5*temp_scale
                else return (temp_country.properties.name.split(" ")[0].length+detail_text.length)*font_scale*8*temp_scale
            })
            .attr("height",function(){
                // if(temp_country.properties.name.split(" ").length>=2)
                if(temp_lan=="chinese") return height/23

                return height/25*(temp_country.properties.name.split(" ").length>=2?2:1)
            })
            .style("opacity",function(){
                if(use_dragBlock==1 && temp_country.properties.main_data[temp_time.toString()]==0) return 0
                return 0.3
            })


        d3.selectAll(".country_text")
            .style("fill-opacity",0)
        d3.selectAll(".country_text2")
            .style("fill-opacity",0)

        d3.selectAll(".mouseover_text_2")
            .attr("font-size",function(d,i){
                if(d.properties.name==temp_country.properties.name){
                    return width/80
                }
                else if(hasRelation(d,temp_country)==1){
                    return 12*font_scale
                }
                else return 0;
            })
            .attr("dx",function(d){
                if(d.properties.name==temp_country.properties.name){
                    return d.properties.dx+dx_remark;
                }
                else return d.properties.dx
            })
            .attr("dy",function(d){
                if(d.properties.name==temp_country.properties.name){
                    if(temp_country.properties.name=="Tanzania"||temp_country.properties.name=="Cuba"||temp_country.properties.name=="Portugal"||temp_country.properties.name=="Ivory Coast") return d.properties.dy+dy_remark*1/3
                    return d.properties.dy-dy_remark*0.6;
                }
                else return d.properties.dy
            })
            .text(function(d,i){
                if(use_dragBlock==1 && temp_country.properties.main_data[temp_time.toString()]==0) return ""
                if(temp_lan=="chinese"){
                    if(d.properties.hasData==1) return d.properties.chinese_name.split(" ")[1]
                    if(hasRelation(d,temp_country)==1){
                        return d.properties.chinese_name.split(" ")[1]
                }
                }
                if(d.properties.hasData==1) return d.properties.name.split(" ")[1]
                if(hasRelation(d,temp_country)==1){
                    return d.properties.name.split(" ")[1]
                }
            })
            .style("fill-opacity",function(d){
                if(hasPath==1&&hasRelation(d,temp_country)==1) return 1
                    if(d.properties.hasData==1&&d==temp_country) return 1
                        else return 0
            })
            .attr("font-size",10*font_scale)
            ;
        d3.selectAll(".mouseover_text_1")
            .attr("font-size",function(d,i){
                if(d.properties.name==temp_country.properties.name){
                    return width/80
                }
                else if(hasRelation(d,temp_country)==1){
                    return 12*font_scale
                }
                else return 0;
            })
            .attr("dx",function(d){
                if(d.properties.name==temp_country.properties.name){
                    return d.properties.dx+dx_remark;
                }
                else return d.properties.dx
            })
            .attr("dy",function(d){
                if(d.properties.name==temp_country.properties.name){
                    if(temp_country.properties.name=="Tanzania"||temp_country.properties.name=="Cuba"||temp_country.properties.name=="Portugal"||temp_country.properties.name=="Ivory Coast") return d.properties.dy
                    return d.properties.dy-dy_remark*2/3;
                }
                else return d.properties.dy
            })
            .text(function(d,i){
                if(use_dragBlock==1 && temp_country.properties.main_data[temp_time.toString()]==0) return ""
                let detail_text=""
                    if(is_rect2axis==0&&d==temp_country){
                        detail_text+=("case:"+d.properties.main_data[temp_time.toString()]+" ")
                        detail_text+=("cured:"+d.properties.cure_data[temp_time.toString()]+" ")                      
                        detail_text+=("dead:"+d.properties.death_data[temp_time.toString()]+" ")
                    }
                        else detail_text=d.properties.main_data
                if(temp_lan=="chinese"){
                    if(d.properties.hasData==1&&d==temp_country) return d.properties.chinese_name.split(" ")[0]+", "+detail_text
                    if(hasPath==1&&hasRelation(d,temp_country)==1){
                        return d.properties.chinese_name.split(" ")[0]
                }
                }
                if(d.properties.hasData==1&&d==temp_country) return d.properties.name.split(" ")[0]+", "+detail_text
                if(hasPath==1&&hasRelation(d,temp_country)==1){
                    return d.properties.name.split(" ")[0]
                }
            })
            .style("fill-opacity",1)
            .attr("font-size",10*font_scale);
        d3.selectAll(".country_num_text")
            .style("opacity",0)

        //æ¹åè¿çº¿çæ¾ç¤º
        d3.selectAll(".links")
            .style("stroke-width",function(d,i){
                //console.log(d)
                if(d.source.name==temp_country.properties.name||d.target.name==temp_country.properties.name){
                    return 2;
                }
                else{
                    return 0
                }
            })
            .style("fill",function(d){
                if((Math.abs(d.target.x-d.source.x)<15||d.source.name=="Portugal")){
                    if(d.source.name==temp_country.properties.name||d.target.name==temp_country.properties.name){
                    return "black"
                }
                }

             }).style("opacity",function(d){
                if(use_dragBlock==1 && d.date>temp_time) return 0
                return 1
            })
        //æ¹åä¼ æ­å°çååçéæåº¦
       d3.selectAll(".mycircle")
        .attr("r",function(d,i){
            if(d.source.name==temp_country.properties.name||d.target.name==temp_country.properties.name){
                    return 10*font_scale
                }
                else{
                    return 0.1
                }
        })
        .style("fill-opacity",function(d,i){
            if(d.source.name==temp_country.properties.name||d.target.name==temp_country.properties.name) return 1
                else return 0
        })
        .style("opacity",function(d){
                if(use_dragBlock==1 && d.date>temp_time) return 0
                return 1
            })

    }

    //ç§»å¼åæ¢å¤
    function Regainmessage(temp_country){
        d3.selectAll(".viewrect")
            .style("fill-opacity",0)
        d3.selectAll(".mouseover_text_1")
            .style("fill-opacity",0)
        d3.selectAll(".mouseover_text_2")
            .style("fill-opacity",0)
        change_to_timerange(axis_start,temp_time)
        return true
        d3.select(".state")
            .selectAll("path")
        .transition().duration(500)
        .attr("fill",function(d,i){
                    //console.log(d)
                    if(d.properties.stage=='null'){
                    }
                    else{
                        return color(d.properties.stage)
                    }
                });

        d3.selectAll(".mouseover_text_1")
            .style("fill-opacity",0)
        d3.selectAll(".mouseover_text_2")
            .style("fill-opacity",0)
        d3.selectAll(".country_num_text")
            .style("opacity",1)
        d3.selectAll(".country_text")
            .attr("font-size",function(d,i){
                return 11*font_scale
            })
            .attr("dx",function(d,i){
                return d.properties.dx;

            })
            .attr("dy",function(d,i){
                    return d.properties.dy
            })
            .text(function(d,i){
                if(d.properties.hasData==1){
                    if(temp_lan=="chinese") return d.properties.chinese_name.split(" ")[0]
                    return d.properties.name.split(" ")[0]
                }
            })
            .attr("font-size", function(d,i){
                if(d.properties.main_data==1996) return 8*font_scale
                    else return 11*font_scale
            })
            .style("fill-opacity",1)
            ;
        d3.selectAll(".country_text2")
            .attr("font-size",function(d,i){
                return 11*font_scale
            })
            .attr("dx",function(d,i){
                return d.properties.dx;

            })
            .attr("dy",function(d,i){
                
                    return d.properties.dy
            })
            .text(function(d,i){
                if(d.properties.hasData==1){
                    if(temp_lan=="chinese") return ""
                    return d.properties.name.split(" ")[1]
                }
                    
            })
            .attr("font-size", function(d,i){
                if(d.properties.main_data==1996) return 8*font_scale
                    else return 11*font_scale
            })
            .style("fill-opacity",1);


        //æ¹åè¿çº¿çæ¾ç¤º
        d3.selectAll(".links")
            .style("stroke-width",function(d,i){
            })
            .style("fill",function(d){
                if((Math.abs(d.target.x-d.source.x)<15||d.source.name=="Portugal")) return "black"
            })
            .style("opacity",show_path)


        //æ¹åä¼ æ­å°çååçéæåº¦
        d3.selectAll(".mycircle")
            .attr("r",function(d,i){
                return 5*font_scale
            })
            .style("fill-opacity",function(d,i){
                return 1
            })
            .style("opacity",show_path)


    }


    //æ­æ¾å¨ç»
    function show_process(start,end){
        //console.log(is_rect2axis)
        let duration_time=0
        let animation_t=d3.timer(function(){
            d3.selectAll(".button_stop").attr("fill-opacity",1);
            if(change_view==1||parseInt(start) > end){//ç»ææ­æ¾
                //console.log(start)
                console.log("end")
                isEnd=1;
                d3.selectAll(".button_rect")
                        .attr("fill-opacity",1)
                d3.selectAll(".button_stop").attr("fill-opacity",0);
                animation_t.stop();

                return true; 
            }
            if(show_detail==1){
                d3.selectAll(".country_num_text")
                    .transition()
                    .duration(duration_time)
                    .text(function(d){
                        if(is_rect2axis==0){
                            let brush_num=d.properties.main_data[parseInt(start).toString()]
                            if(isNaN(brush_num)||brush_num==0) return ""
                                else return brush_num
                        }
                    })
            }

            d3.select(".state")
                .selectAll("path")
                .transition()
                .duration(duration_time)
                .attr("fill",function(d,i){
                    if(d.properties.hasData==1){
                            if(is_rect2axis==0){
                                let brush_num=d.properties.main_data[parseInt(start).toString()]
                                //if(d.properties.chinese_name=="ä¸­å½") console.log(num1-num0)
                                for(var k=0;k<data_range.length;k++){
                                    if(brush_num<=data_range[k].range[1]&&brush_num>=data_range[k].range[0]) return color(k)
                                }
                                return 
                            }
                            if(d.properties.main_data.length==5){
                                temp_year=parseInt(d.properties.main_data.substr(0,4))
                                if(temp_year<start){
                                return color(d.properties.stage)
                            }}
                            if(d.properties.main_data<start){
                                return color(d.properties.stage)
                            }
                            else{
                                return "rgb(160,160,160)"
                            }
                        }
                        }); 
            //æ¹åæå­
            d3.selectAll(".country_text")
                .transition()
                .duration(duration_time)
                .style("opacity",function(d){
                    if(is_rect2axis==0){
                         let brush_num=d.properties.main_data[parseInt(start).toString()]
                            //if(d.properties.chinese_name=="ä¸­å½") console.log(num1-num0)
                         if (brush_num>0) return 1
                            else return 0
                    }
                    else if(d.properties.main_data.length==5){
                                temp_year=parseInt(d.properties.main_data.substr(0,4))
                                if(temp_year<start){
                                return 1
                            }}
                    if(d.properties.main_data<start) return 1
                    else return 0
                });
            d3.selectAll(".country_text2")
                .transition()
                .duration(duration_time)
                .style("fill-opacity",function(d){
                    if(is_rect2axis==0){
                         let brush_num=d.properties.main_data[parseInt(start).toString()]
                            //if(d.properties.chinese_name=="ä¸­å½") console.log(num1-num0)
                         if (brush_num>0) return 1
                            else return 0
                    }
                    else if(d.properties.main_data<start) return 1
                    else return 0
                })
            d3.selectAll(".mycircle")
                .transition()
                .duration(duration_time)
                .attr("r",function(d,i){
                    if(d.main_data<start){
                            return 6*font_scale
                    }
                    else{
                        return 0
                    }
                })
                .attr("fill-opacity",function(d,i){
                    if(d.main_data<start) return 1
                        else return 0
                })
        //æ¹åè¿çº¿çæ¾ç¤º
        d3.selectAll(".links")
            .transition()
            .duration(duration_time)
            .style("fill",function(d){
                if((Math.abs(d.target.x-d.source.x)<15||d.source.name=="Portugal")){
                    if(d.main_data<=start) return "black"
                }
            })
            .style("stroke-width",function(d,i){
                //console.log(d)
                if(d.main_data==parseInt(start)){
                    return 2.5;
                }
                else if(d.main_data<start){
                    return 2
                }
                else{
                    return 0
                }
            })
            .style("opacity",function(d){
                if(d.main_data==parseInt(start)){
                    return 1;
                }
                else if(d.main_data<start){
                    //console.log(d.main_data)
                    return 1
                }
                else{
                    return 0
                }
            })

        d3.selectAll(".range_text")
            .text(axis_start+"-"+parseInt(start))
            .style("fill","white")
            .style("opacity",1)
        let gap_num=axis_end-axis_start
            if(play_flag==0){
                d3.selectAll(".button_stop").attr("fill-opacity",0);
                start+=0
            }
            else if(is_rect2axis==0){
                start=start+0.04
                if(start+0.04>parseInt(start)+1){
                    start=parseInt(countDate(parseInt(start),1).replaceAll("/",""))
                }
            }
            /*else if(start<1920) start=start+0.1
            else if(start<1956) start+=3
            else if(start<1978) start+=0.1
            else if(start<1996) start+=0.03
            else if(start<2004) start+=0.1
            else start+=0.03*/
            else if(start<axis_start+gap_num*0.1){
                start=start+0.1
            }
            else if(start<axis_start+gap_num*0.3) start+=3
            else if(start<axis_start+gap_num*0.4) start+=0.1
            else if(start<axis_start+gap_num*0.6) start+=0.03
            else if(start<axis_start+gap_num*0.8) start+=0.1
            else start+=0.03       
        });
    }

    String.prototype.replaceAll = function(s1, s2) {
        return this.replace(new RegExp(s1, "gm"), s2);
    }

    //è¿çº¿æ¹å¼1
    function link(d) {
        local1=proj([d.source.x, d.source.y]);
        local2=proj([d.target.x, d.target.y]);
        circle_r=12*font_scale
        pm_x=1*font_scale
        pm_y=1*font_scale
        if(local1[0]>local2[0]) pm_x=-1
        if(local1[0]>local2[0]) pm_y=-1
       return "M" + (local1[0]) + "," + (local1[1])
      //+ "C" + (local1[0] + local2[0]) / 2 + "," + local1[1]
      + "S" + (8/9*local1[0] + local2[0]/9) + "," + (1/9*local1[1] + 8*local2[1]/9)
      + " " + (local2[0]-circle_r*pm_x) + "," + (local2[1]+2*pm_y);
    }

    //è¿çº¿æ¹å¼2
    function link_2(d) {
        local1=proj([d.source.x, d.source.y]);
        local2=proj([d.target.x, d.target.y]);
        circle_r=12*font_scale
        pm_x=1*font_scale
        pm_y=1*font_scale
        if(local1[0]>local2[0]) pm_x=-1
        if(local1[0]>local2[0]) pm_y=-1
       return "M" + (local1[0]) + "," + (local1[1])
      //+ "C" + (local1[0] + local2[0]) / 2 + "," + local1[1]
      + "S" + (1/4*local1[0] + 3*local2[0]/4) + "," + (3/4*local1[1] + local2[1]/4)
      + " " + (local2[0]-circle_r*pm_x) + "," + (local2[1]+2*pm_y);
    }

    //è¿çº¿æ¹å¼3
    function link_3(d) {
        local1=proj([d.source.x, d.source.y]);
        local2=proj([d.target.x, d.target.y]);
        circle_r=12*font_scale
        pm_x=1*font_scale
        pm_y=1*font_scale
        if(local1[0]>local2[0]) pm_x=-1
        if(local1[0]>local2[0]) pm_y=-1
       return "M" + (local1[0]) + "," + (local1[1])
      //+ "C" + (local1[0] + local2[0]) / 2 + "," + local1[1]
      + "S" + (1/4*local1[0] + 3*local2[0]/4) + "," + (8/9*local1[1] + local2[1]/9)
      + " " + (local2[0]) + "," + (local2[1]-28*pm_y);
    }

    function HideLeftView(){
        d3.select(".mapPanel").style("left","8.5%")
        document.getElementById("LeftSelectPanel").style.display="none"
        document.getElementById("hide_img").style.display="none"
        document.getElementById("show_img").style.display=""
    }
    function ShowLeftView(){
        d3.select(".mapPanel").style("left","15%")
        document.getElementById("LeftSelectPanel").style.display=""
        document.getElementById("hide_img").style.display=""
        document.getElementById("show_img").style.display="none"
    }

    //æ¹ååºç¡å°å¾
    function changeBasicMap(mapFileName){
        play_flag=0
        /*change_view=1
        show_process(axis_start,axis_end)
        change_view=0*/
        selected_map=mapFileName
        temp_map=mapFileName
        if(temp_map=="world"){
            changeView(temp_map+"_"+selected_dataset+".json","path_"+selected_dataset+".json",temp_map+"_web_info_"+selected_dataset+".json")
        }
        else{
            changeView(temp_map+"_"+selected_dataset+".json","",temp_map+"_web_info_"+selected_dataset+".json")
        }
    }

    function changeDataSet(datasetName){
        play_flag=0
        /*change_view=1
        show_process(axis_start,axis_end)
        change_view=0*/
        selected_dataset=datasetName
        if(temp_map=="world"){
            changeView(temp_map+"_"+selected_dataset+".json","path_"+selected_dataset+".json",temp_map+"_web_info_"+selected_dataset+".json")
        }
        else{
            changeView(temp_map+"_"+selected_dataset+".json","",temp_map+"_web_info_"+selected_dataset+".json")
        }

    }

    function changeView(mapDataFile,pathDataFile,componentDataFile){
        console.log(mapDataFile)
        console.log(pathDataFile)
        console.log(componentDataFile)
        if(temp_map=="china"){
            proj=proj_china
            path = d3.geoPath().projection(proj);
        }
        else{
            proj=proj_world
            path = d3.geoPath().projection(proj);
        }
            getMapData(mapDataFile)
            if(pathDataFile!=""){
                getPathData(pathDataFile)
                hasPath=1
            }
                else{
                    hasPath=0
                    path_data={}
                }
            getComponentData(componentDataFile)
            setTimeout(function(){ 
                addMap()
                addMapStatistic()
                addRangeRect()
                addOtherInfo()
                addPlayButton(true)
                addAxis() 
                if(pathDataFile!="") addPath(true)
                    else addPath(false)
                addDistrictName()
            changeLan()
            }, 1000);

    }

    //æ¹åå°å¾å³èçæ°æ®
    function changeMapData(dataFileName){

    }

    //æ¹åè¿çº¿å³èçæ°æ®
    function changePathData(pathFileName){

    }

    //æ¹åè¿çº¿é¢è²çå½æ°
    function changeLineColor(lineColorValue){
        //let tempLineColor="black"
        //if(lineColorValue==0) tempLineColor="yellow"
            //console.log("tempLineColor"+tempLineColor)
        var arrowMarker = d3.select("#arrow")
                        
        arrowMarker.select("path")
            .attr("fill",lineColorValue)
            .attr("fill-opacity",0.7);
        d3.selectAll(".links")
                .style("stroke-width",function(d){
                        return 
                })
                .style("fill",function(d){
                if((Math.abs(d.target.x-d.source.x)<15||d.source.name=="Portugal")){
                    return "black"
                }
                })
                .style("stroke",lineColorValue)
                .attr("stroke-opacity",0.7)
                .attr("marker-end","url(#arrow)")
    }
    //æ¹åååçé¢è²
    function changeCircleColor(circleColorValue){
        d3.selectAll(".mycircle")
            .attr("fill",function(d,i){
                return circleColorValue
            })
            .style("fill-opacity",function(d,i){
                return 1
            })
    }
    //æ¹åç½é¡µçä¸­è±ææ¾ç¤º
    function changeLan(){
        if(temp_lan=="english"){
            temp_lan="chinese"
            $(".titleText").text("å°å¾å¯è§åå·¥å·")
            d3.selectAll(".country_text")
                .text(function(d){
                    if(d.properties.hasData==1) return d.properties.chinese_name
                    else return ""
                })
            d3.selectAll(".country_text2")
                .text(function(d){
                    return ""
                })
            d3.selectAll(".mouseover_text_1")
                .text(function(d){
                    return ""
                })
            d3.selectAll(".mouseover_text_2")
                .text(function(d){
                    return ""
                })

            d3.selectAll(".point_text")
                .text(function(d,i){
                    if (d.chinese_event.split(":").length==2) return d.chinese_event.split(":")[1]
                    return d.year+chineses_unit+": "+d.chinese_event;
                });
            d3.selectAll(".source1")
                .text("æ°æ®æ¥æº: "+dataSource_chinese)
            d3.selectAll(".source2")
                .text("å°å¾æ°æ®æ¥æº: "+mapSource)
            d3.selectAll(".shadow_title")
                  .text(chinese_title);
            d3.selectAll(".title")
                .text(chinese_title)

        }
        else if(temp_lan=="chinese"){
            temp_lan="english"
            $(".titleText").text("Map Visualization Library")
            d3.selectAll(".country_text")
                .text(function(d){
                    if(d.properties.hasData==1) return d.properties.name.split(" ")[0]
                    else return ""
                })
            d3.selectAll(".country_text2")
                .text(function(d){
                    if(d.properties.hasData==1) return d.properties.name.split(" ")[1]
                    return ""
                })

            d3.selectAll(".point_text")
                .text(function(d,i){
                    if (d.chinese_event.split(":").length==2) return d.event.split(":")[1]
                    return d.year+num_unit+": "+d.event;
                });
            d3.selectAll(".source1")
                .text("Data Source: "+dataSource)
            d3.selectAll(".source2")
                .text("Map Source: "+mapSource)
            d3.selectAll(".shadow_title")
                  .text(web_title);
            d3.selectAll(".title")
                .text(web_title)

        }
    }

    //æ ¹æ®æ¶é´è½´çå¼å§æ¥æåä¸­é´é´éçå¤©æ°è®¡ç®åºå¯¹åºçæ¥æ
    function countDate(start_date,gap_days){
        let month_days=[0,31,28,31,30,31,30,31,31,30,31,30,31]
        let temp_year=Math.floor(start_date/10000)
        let temp_month=Math.floor((start_date%10000)/100)
        let temp_day=start_date%100
        while(gap_days>0){
            let temp_year_day=365
            let temp_month_day=month_days[temp_month]
            if(temp_month==2&&isLeapYear(temp_year)==1) temp_month_day=29
            if(temp_month<=2&&isLeapYear(temp_year)==1){
                if(temp_month==2){
                    if(temp_day<=28) temp_year_day=366
                    else temp_day=28
                }
                else temp_year_day=366
            }
            if(gap_days>=temp_year_day){
                temp_year+=1
                gap_days-=temp_year_day
            }
            else{
                let left_month_day=temp_month_day-temp_day
                if(gap_days>left_month_day){
                    temp_month+=1
                    temp_day=1
                    if(temp_month==13){
                        temp_year+=1
                        temp_month=1
                    }
                    gap_days-=(left_month_day+1)
                }
                else{
                    temp_day+=gap_days
                    gap_days=0
                }
            }
        }
        if(temp_month<10) temp_month="0"+temp_month
        if(temp_day<10) temp_day="0"+temp_day
        return temp_year+"/"+temp_month+"/"+temp_day
    }

    //è®¡ç®ä¸¤ä¸ªæ¥æä¹é´çé´éå¤©æ°
    //æ¥æçè®°å½æ ¼å¼ä¸º20180101
    function countGapDays(date0,date1){
        let month_days=[0,31,28,31,30,31,30,31,31,30,31,30,31]
        let year0=Math.floor(date0/10000)
        let month0=Math.floor((date0%10000)/100)
        let day0=date0%100
        let year1=Math.floor(date1/10000)
        let month1=Math.floor((date1%10000)/100)
        let day1=date1%100
        console.log("date0:"+year0+":"+month0+":"+day0)
        console.log("date1:"+year1+":"+month1+":"+day1)
        let temp_gap_days=0
        //ä¸­é´çå¹´ä»½æå¤å°å¤©
        for(var mid_year=year0+1;mid_year<year1;mid_year++){
            if(isLeapYear(mid_year)) temp_gap_days+=366
            else temp_gap_days+=365
        }
        //å¦ææ¯åä¸å¹´
        if(year1==year0){
            if(month0==month1){
                temp_gap_days=temp_gap_days+(day1-day0)
            }
            else for(var temp_month=month0;temp_month<=month1;temp_month++){
                let gap_month_day=month_days[temp_month]
                if(isLeapYear(year0)&&temp_month==2) gap_month_day=29
                if(temp_month==month0) gap_month_day-=day0
                    else if(temp_month==month1) gap_month_day=day1
                temp_gap_days+=gap_month_day
            }
        }
        //å¦æä¸æ¯åä¸å¹´
        else{
            for(var i=month0;i<=12;i++){
                let gap_month_day=month_days[i]
                if(i==2&&isLeapYear(year0)) gap_month_day=29
                if(i==month0) gap_month_day-=day0
                temp_gap_days+=gap_month_day
            }
            for(var i=1;i<=month1;i++){
                let gap_month_day=month_days[i]
                if(i==2&&isLeapYear(year0)) gap_month_day=29
                if(i==month1) gap_month_day=day1
                temp_gap_days+=gap_month_day
            }
        }
        console.log("temp_gap_days ",temp_gap_days)
        return temp_gap_days
    }

    //å¤æ­æä¸ªå¹´ä»½æ¯å¦ä¸ºé°å¹´
    function isLeapYear(temp_year){
        if(temp_year%100==0){
            if(temp_year%400==0) return 1
        }
        else if(temp_year%4==0){
            return 1
        }
        return 0
    }



</script>
</div>
</body>
 
</html>